{% extends 'base.html' %}
{% load static %}

{% block title %}Детали импорта{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Детали импорта</h1>
        <div>
            <a href="{% url 'subscribers:import_history' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> К истории импорта
            </a>
            <a href="{% url 'subscribers:import_csv' %}" class="btn btn-primary ms-2">
                <i class="bi bi-file-earmark-arrow-up"></i> Новый импорт
            </a>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Информация об импорте</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Файл:</h6>
                        <p class="mb-0">{{ import_history.file_name }}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Дата импорта:</h6>
                        <p class="mb-0">{{ import_history.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Пользователь:</h6>
                        <p class="mb-0">{{ import_history.created_by.username }}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Размер файла:</h6>
                        <p class="mb-0">{{ import_history.file_size|filesizeformat }}</p>
                    </div>
                    
                    {% if import_history.info_message %}
                        <div class="alert alert-info mt-3">
                            <h6 class="alert-heading">Информация об архивации</h6>
                            <p class="mb-0">{{ import_history.info_message }}</p>
                        </div>
                    {% endif %}
                    
                    {% if import_history.error_message %}
                        {% if "архивирована как" in import_history.error_message %}
                            <div class="alert alert-info mt-3">
                                <h6 class="alert-heading">Информация об архивации</h6>
                                <p class="mb-0">
                                    Предыдущая таблица абонентов была сохранена в архивную таблицу. 
                                    При этом импорте все предыдущие данные были заменены новыми.
                                </p>
                                <p class="mb-0 mt-2">
                                    <small class="text-muted">Имя архивной таблицы: {{ import_history.archive_table_name }}</small>
                                </p>
                            </div>
                        {% elif "Сохранено последних архивных таблиц" in import_history.error_message %}
                            <div class="alert alert-info mt-3">
                                <h6 class="alert-heading">Информация об архивации</h6>
                                <p class="mb-0">{{ import_history.error_message }}</p>
                            </div>
                        {% else %}
                            <div class="alert alert-danger mt-3">
                                <h6 class="alert-heading">Сообщение об ошибке</h6>
                                <p class="mb-0">{{ import_history.error_message }}</p>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Статистика</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Статус</h6>
                                    {% if import_history.status == 'completed' %}
                                        <span class="badge bg-success fs-6">Завершено</span>
                                    {% elif import_history.status == 'temp_completed' %}
                                        <span class="badge bg-warning text-dark fs-6">Ожидает финализации</span>
                                    {% elif import_history.status == 'processing' %}
                                        <span class="badge bg-warning text-dark fs-6">В обработке</span>
                                    {% elif import_history.status == 'paused' %}
                                        <span class="badge bg-info fs-6">На паузе</span>
                                    {% elif import_history.status == 'cancelled' %}
                                        <span class="badge bg-secondary fs-6">Отменено</span>
                                    {% elif import_history.status == 'failed' %}
                                        <span class="badge bg-danger fs-6">Ошибка</span>
                                    {% elif import_history.status == 'uploading' %}
                                        <span class="badge bg-info fs-6">Загрузка файла</span>
                                    {% elif import_history.status == 'pending' %}
                                        <span class="badge bg-primary fs-6">Ожидает</span>
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{{ import_history.status }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                                                 <div class="col-6">
                             <div class="card bg-light">
                                 <div class="card-body text-center">
                                     <h6 class="card-title">Всего записей</h6>
                                     <span id="total-records-count" class="fs-4">{{ import_history.records_count }}</span>
                                 </div>
                             </div>
                         </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Создано</h6>
                                    <span id="created-count" class="fs-4 text-success">{{ import_history.records_created }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Ошибок</h6>
                                    <span id="failed-count" class="fs-4 text-danger">{{ import_history.records_failed }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="progress">
                            <div id="import-progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="d-flex justify-content-between small mt-1">
                            <span>Обработано: <span id="processed-count">{{ import_history.processed_rows }}</span> / <span id="total-count">{{ import_history.records_count }}</span></span>
                        </div>
                        <div class="mt-2 d-flex gap-2">
                            <button id="pause-button" class="btn btn-sm btn-outline-warning" type="button" style="display:none;">Пауза</button>
                            <button id="resume-button" class="btn btn-sm btn-outline-primary" type="button" style="display:none;">Возобновить</button>
                            <button id="cancel-button" class="btn btn-sm btn-outline-danger" type="button" style="display:none;">Отмена</button>
                            <button id="finalize-button" class="btn btn-sm btn-success" type="button" style="display:none;">
                                <i class="bi bi-check-circle"></i> Финализировать импорт
                            </button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Инициализация
                                <span id="step-initializing" class="badge bg-secondary">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Подсчёт записей
                                <span id="step-counting" class="badge bg-secondary">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Создание временной таблицы
                                <span id="step-creating_temp_table" class="badge bg-secondary">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Импорт записей
                                <span id="step-processing" class="badge bg-secondary">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Ожидание финализации
                                <span id="step-waiting_finalization" class="badge bg-secondary">...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Финализация
                                <span id="step-finalizing" class="badge bg-secondary">...</span>
                            </li>
                                                         <li class="list-group-item d-flex justify-content-between align-items-center">
                                 Завершение
                                 <span id="step-completed" class="badge bg-secondary">...</span>
                             </li>
                        </ul>
                    </div>

                    <!-- Кнопка показа ошибок (скрыта по умолчанию, показывается JavaScript'ом) -->
                    <div id="errors-button-container" class="mt-3" style="display: none;">
                        <button id="show-errors-btn" class="btn btn-outline-danger btn-sm" type="button">
                            <i class="bi bi-exclamation-triangle"></i> Показать ошибки (<span id="errors-count">0</span>)
                        </button>
                    </div>
                    
                    <!-- Скрытый блок с ошибками -->
                    <div id="errors-container" class="mt-3" style="display: none;">
                        <h6 class="text-danger">Детали ошибок импорта:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Строка</th>
                                        <th>Ошибка</th>
                                        <th>Исходные данные</th>
                                    </tr>
                                </thead>
                                <tbody id="errors-table-body">
                                    <!-- Содержимое таблицы будет заполнено JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="errors-info" class="text-muted small mt-2">
                            <!-- Информация о количестве ошибок -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importId = {{ import_history.id }};
    const bar = document.getElementById('import-progress-bar');
    const processedEl = document.getElementById('processed-count');
    const totalEl = document.getElementById('total-count');
    const resumeBtn = document.getElementById('resume-button');
    const pauseBtn = document.getElementById('pause-button');
    const cancelBtn = document.getElementById('cancel-button');
    const finalizeBtn = document.getElementById('finalize-button');
    const showErrorsBtn = document.getElementById('show-errors-btn');
    const errorsContainer = document.getElementById('errors-container');
    const errorsTableBody = document.getElementById('errors-table-body');
    const errorsInfo = document.getElementById('errors-info');
    const errorsButtonContainer = document.getElementById('errors-button-container');
    const errorsCount = document.getElementById('errors-count');

    // Функция для загрузки ошибок импорта
    function loadErrors() {
        if (!errorsContainer || !errorsTableBody || !errorsInfo) return;
        
        fetch(`{% url 'subscribers:import_errors' 0 %}`.replace('0', importId))
            .then(r => r.json())
            .then(data => {
                if (data.errors && data.errors.length > 0) {
                    // Очищаем таблицу
                    errorsTableBody.innerHTML = '';
                    
                    // Добавляем ошибки (максимум 10)
                    const errorsToShow = data.errors.slice(0, 10);
                    errorsToShow.forEach(error => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="text-center">${error.row_index}</td>
                            <td class="text-danger">${error.message}</td>
                            <td class="font-monospace small">
                                ${error.raw_data ? error.raw_data.substring(0, 100) : '<em class="text-muted">Данные не сохранены</em>'}
                            </td>
                        `;
                        errorsTableBody.appendChild(row);
                    });
                    
                    // Обновляем информацию о количестве
                    if (data.total_errors > 10) {
                        errorsInfo.innerHTML = `
                            Показано первых 10 ошибок из ${data.total_errors}. 
                            Для просмотра всех ошибок воспользуйтесь админ-панелью.
                        `;
                    } else {
                        errorsInfo.innerHTML = `Показано ${data.total_errors} ошибок.`;
                    }
                    
                    // Показываем контейнер
                    errorsContainer.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке ошибок:', error);
            });
    }
    
    // Функция для обновления кнопки ошибок
    function updateErrorsButton(failedCount) {
        if (errorsButtonContainer && errorsCount) {
            if (failedCount > 0) {
                // Показываем кнопку и обновляем счетчик
                errorsButtonContainer.style.display = 'block';
                errorsCount.textContent = failedCount;
                
                // Если таблица уже открыта, обновляем данные
                if (errorsContainer && errorsContainer.style.display !== 'none') {
                    loadErrors();
                }
            } else {
                // Скрываем кнопку и таблицу если ошибок нет
                errorsButtonContainer.style.display = 'none';
                errorsContainer.style.display = 'none';
            }
        }
    }
    
    function markStep(phase){
        const steps = ['initializing','counting','creating_temp_table','processing','waiting_finalization','finalizing','completed'];
        
        // Если импорт отменен, помечаем только невыполненные этапы как отменено
        if (phase === 'cancelled') {
            steps.forEach(s => {
                const el = document.getElementById('step-' + s);
                if (!el) return;
                
                // Проверяем, был ли этап уже выполнен
                const currentClasses = el.classList;
                if (currentClasses.contains('bg-success')) {
                    // Этап уже выполнен - оставляем "OK"
                    el.classList.remove('bg-secondary','bg-info','bg-warning','bg-danger');
                    el.classList.add('bg-success');
                    el.textContent = 'OK';
                } else {
                    // Этап не был выполнен - помечаем как отменено
                    el.classList.remove('bg-secondary','bg-info','bg-success','bg-warning','bg-danger');
                    el.classList.add('bg-danger');
                    el.textContent = 'Отменено';
                }
            });
            return;
        }
        
        steps.forEach(s => {
            const el = document.getElementById('step-' + s);
            if (!el) return;
            el.classList.remove('bg-secondary','bg-info','bg-success','bg-warning','bg-danger');
            el.textContent = '...';
        });
        const currentIdx = steps.indexOf(phase);
        steps.forEach((s, idx) => {
            const el = document.getElementById('step-' + s);
            if (!el) return;
            if (currentIdx === -1) {
                el.classList.add('bg-secondary');
                el.textContent = '...';
            } else if (idx < currentIdx) {
                el.classList.add('bg-success');
                el.textContent = 'OK';
            } else if (idx === currentIdx) {
                if (phase === 'waiting_finalization') {
                    el.classList.add('bg-warning');
                    el.textContent = 'Ожидает';
                } else if (phase === 'completed') {
                    el.classList.add('bg-success');
                    el.textContent = 'OK';
                } else {
                    el.classList.add('bg-info');
                    el.textContent = 'Выполняется';
                }
            } else {
                el.classList.add('bg-secondary');
                el.textContent = '...';
            }
        });
    }

    function updateUI(data){
        const total = data.total || 0;
        const processed = data.processed || 0;
        
        console.log('updateUI - данные:', { 
            total, 
            processed, 
            records_count: data.records_count, 
            status: data.status,
            all_data: data  // Логируем все данные для отладки
        });
        
        if (total > 0) {
            const pct = typeof data.progress_percent === 'number' ? data.progress_percent : Math.floor((processed / total) * 100);
            bar.style.width = pct + '%';
            bar.setAttribute('aria-valuenow', pct);
            bar.textContent = pct + '%';
        } else {
            bar.style.width = '0%';
            bar.setAttribute('aria-valuenow', 0);
            bar.textContent = '0%';
        }
        
        processedEl.textContent = processed;
        
        // Обновляем поле "Всего записей" из data.records_count если оно доступно
        // При отмене импорта не изменяем поле "Всего записей"
        if (data.status === 'cancelled') {
            console.log('updateUI - импорт отменен, поле "Всего записей" не изменяется');
        } else if (data.records_count !== undefined && data.records_count > 0) {
            totalEl.textContent = data.records_count;
            console.log('updateUI - обновлено поле "Всего записей" из records_count:', data.records_count);
        } else if (total > 0) {
            totalEl.textContent = total;
            console.log('updateUI - обновлено поле "Всего записей" из total:', total);
        } else {
            totalEl.textContent = '0';
            console.log('updateUI - поле "Всего записей" установлено в 0');
        }
        
        console.log('updateUI - обновлены элементы:', { 
            processedEl: processedEl.textContent, 
            totalEl: totalEl.textContent 
        });

        if (data.phase) markStep(data.phase);
        
        // обновляем числовые блоки без перезагрузки
        const createdEl = document.getElementById('created-count');
        const failedEl = document.getElementById('failed-count');
        if (createdEl && typeof data.records_created === 'number') createdEl.textContent = data.records_created;
        if (failedEl && typeof data.records_failed === 'number') {
            failedEl.textContent = data.records_failed;
            // Всегда устанавливаем красный цвет для ошибок
            failedEl.className = 'fs-4 text-danger';
            
            // Обновляем кнопку ошибок
            updateErrorsButton(data.records_failed);
        }

        // Обновляем видимость кнопок
        const showResume = (data.status === 'failed' || data.status === 'pending' || data.status === 'paused');
        const showPause = (data.status === 'processing');
        const showCancel = (data.status === 'processing' || data.status === 'paused' || data.status === 'pending' || data.status === 'uploading');
        const showFinalize = (data.status === 'temp_completed');
        
        // Если импорт отменен, показываем все этапы как отменено
        if (data.status === 'cancelled') {
            markStep('cancelled');
        }
        
        // Обновляем статус в заголовке карточки
        const statusBadge = document.querySelector('.card-body .badge');
        if (statusBadge) {
            statusBadge.className = 'badge fs-6';
            if (data.status === 'completed') {
                statusBadge.classList.add('bg-success');
                statusBadge.textContent = 'Завершено';
            } else if (data.status === 'temp_completed') {
                statusBadge.classList.add('bg-warning', 'text-dark');
                statusBadge.textContent = 'Ожидает финализации';
            } else if (data.status === 'processing') {
                statusBadge.classList.add('bg-warning', 'text-dark');
                statusBadge.textContent = 'В обработке';
            } else if (data.status === 'paused') {
                statusBadge.classList.add('bg-info');
                statusBadge.textContent = 'На паузе';
            } else if (data.status === 'cancelled') {
                statusBadge.classList.add('bg-secondary');
                statusBadge.textContent = 'Отменено';
            } else if (data.status === 'failed') {
                statusBadge.classList.add('bg-danger');
                statusBadge.textContent = 'Ошибка';
            } else if (data.status === 'uploading') {
                statusBadge.classList.add('bg-info');
                statusBadge.textContent = 'Загрузка файла';
            } else if (data.status === 'pending') {
                statusBadge.classList.add('bg-primary');
                statusBadge.textContent = 'Ожидает';
            } else {
                statusBadge.classList.add('bg-secondary');
                statusBadge.textContent = data.status;
            }
        }
        
        // Обновляем поле "Всего записей" в карточке статистики
        // При отмене импорта не изменяем поле "Всего записей"
        const totalRecordsCountEl = document.getElementById('total-records-count');
        if (data.status === 'cancelled') {
            console.log('updateUI - импорт отменен, поле "Всего записей" в карточке не изменяется');
        } else if (totalRecordsCountEl && data.records_count !== undefined) {
            totalRecordsCountEl.textContent = data.records_count;
            console.log('updateUI - обновлено поле "Всего записей" в карточке:', data.records_count);
        }
        
        resumeBtn.style.display = showResume ? 'inline-block' : 'none';
        pauseBtn.style.display = showPause ? 'inline-block' : 'none';
        cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
        finalizeBtn.style.display = showFinalize ? 'inline-block' : 'none';
        
        console.log('Кнопки обновлены:', {
            resume: showResume,
            pause: showPause,
            cancel: showCancel,
            finalize: showFinalize,
            status: data.status
        });
    }

    function poll(){
        fetch('{% url "subscribers:import_status" 0 %}'.replace('0', importId))
            .then(r => r.json())
            .then(data => {
                console.log('Статус импорта обновлен:', data);
                console.log('Перед updateUI - totalEl.textContent:', totalEl.textContent);
                updateUI(data);
                console.log('После updateUI - totalEl.textContent:', totalEl.textContent);
                if (data.status === 'processing' || data.status === 'paused' || data.status === 'pending') {
                    setTimeout(poll, 1500);
                } else if (data.status === 'temp_completed') {
                    // Для temp_completed показываем кнопку финализации, но не запускаем периодическое обновление
                    console.log('Импорт во временную таблицу завершен, ожидаем финализации');
                }
            })
            .catch((error) => {
                console.error('Ошибка при получении статуса:', error);
                setTimeout(poll, 3000);
            });
    }

    function getCookie(name){
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    resumeBtn?.addEventListener('click', function(){
        console.log('Кнопка "Возобновить" нажата для импорта', importId);
        fetch('{% url "subscribers:import_resume" 0 %}'.replace('0', importId), {method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') || '' }})
            .then(r => r.json())
            .then(data => {
                console.log('Ответ от сервера при возобновлении:', data);
                poll();
            })
            .catch(error => {
                console.error('Ошибка при возобновлении импорта:', error);
            });
    });
    
    pauseBtn?.addEventListener('click', function(){
        console.log('Кнопка "Пауза" нажата для импорта', importId);
        fetch('{% url "subscribers:import_pause" 0 %}'.replace('0', importId), {method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') || '' }})
            .then(r => r.json())
            .then(data => {
                console.log('Ответ от сервера при паузе:', data);
                poll();
            })
            .catch(error => {
                console.error('Ошибка при паузе импорта:', error);
            });
    });
    
    cancelBtn?.addEventListener('click', function(){
        if (!confirm('Остановить импорт? Действие нельзя отменить.')) return;
        console.log('Кнопка "Отмена" нажата для импорта', importId);
        fetch('{% url "subscribers:import_cancel" 0 %}'.replace('0', importId), {method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') || '' }})
            .then(r => r.json())
            .then(data => {
                console.log('Ответ от сервера при отмене:', data);
                poll();
            })
            .catch(error => {
                console.error('Ошибка при отмене импорта:', error);
            });
    });

    // Обработчик для кнопки финализации
    finalizeBtn?.addEventListener('click', function(){
        if (!confirm('Финализировать импорт? Данные из временной таблицы будут перенесены в основную таблицу. Действие нельзя отменить.')) return;
        console.log('Кнопка "Финализировать" нажата для импорта', importId);
        
        // Блокируем кнопку на время выполнения
        finalizeBtn.disabled = true;
        finalizeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Финализация...';
        
        fetch('{% url "subscribers:import_finalize" 0 %}'.replace('0', importId), {
            method: 'POST', 
            headers: { 
                'X-Requested-With': 'XMLHttpRequest', 
                'X-CSRFToken': getCookie('csrftoken') || '' 
            }
        })
        .then(r => r.json())
        .then(data => {
            console.log('Ответ от сервера при финализации:', data);
            if (data.success) {
                alert('Импорт успешно финализирован!');
                // Обновляем статус импорта
                setTimeout(poll, 1000);
            } else {
                alert('Ошибка при финализации: ' + data.error);
                // Возвращаем кнопку в исходное состояние
                finalizeBtn.disabled = false;
                finalizeBtn.innerHTML = '<i class="bi bi-check-circle"></i> Финализировать импорт';
            }
        })
        .catch((error) => {
            console.error('Ошибка при финализации импорта:', error);
            alert('Произошла ошибка при финализации импорта');
            // Возвращаем кнопку в исходное состояние
            finalizeBtn.disabled = false;
            finalizeBtn.innerHTML = '<i class="bi bi-check-circle"></i> Финализировать импорт';
        });
    });
    
    // Обработчик для кнопки показа ошибок
    showErrorsBtn?.addEventListener('click', function(){
        if (errorsContainer.style.display === 'none') {
            loadErrors();
        } else {
            errorsContainer.style.display = 'none';
            this.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Показать ошибки (<span id="errors-count">0</span>)`;
        }
    });

    // Инициализация: показываем кнопку ошибок если они уже есть
    if ({{ import_history.records_failed }} > 0) {
        updateErrorsButton({{ import_history.records_failed }});
    }
    
    poll();
});
</script>
{% endblock %} 