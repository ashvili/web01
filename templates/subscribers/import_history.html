{% extends 'base.html' %}
{% load static %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–∞{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–∞</h1>
        <div>
            <a href="{% url 'subscribers:list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
            </a>
            <button id="list-archives-btn" class="btn btn-outline-info ms-2" type="button">
                <i class="bi bi-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏–≤—ã
            </button>
            <button id="cleanup-archives-btn" class="btn btn-outline-danger ms-2" type="button">
                <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã
            </button>
            <a href="{% url 'subscribers:import_csv' %}" class="btn btn-primary ms-2">
                <i class="bi bi-file-earmark-arrow-up"></i> –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
            </a>
        </div>
    </div>
    
    {% if history_page %}
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">–°–ø–∏—Å–æ–∫ –∏–º–ø–æ—Ä—Ç–æ–≤</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–∞–π–ª</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ó–∞–ø–∏—Å–µ–π</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for import_item in history_page %}
                                <tr>
                                    <td>{{ import_item.id }}</td>
                                    <td>{{ import_item.file_name }}</td>
                                    <td>{{ import_item.created_at|date:"d.m.Y H:i" }}</td>
                                    <td>{{ import_item.created_by.username }}</td>
                                    <td>
                                        {% if import_item.status == 'completed' %}
                                            <span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                        {% elif import_item.status == 'processing' %}
                                            <span class="badge bg-warning text-dark">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>
                                        {% elif import_item.status == 'paused' %}
                                            <span class="badge bg-info">–ù–∞ –ø–∞—É–∑–µ</span>
                                        {% elif import_item.status == 'cancelled' %}
                                            <span class="badge bg-secondary">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
                                        {% elif import_item.status == 'failed' %}
                                            <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                        {% elif import_item.status == 'pending' %}
                                            <span class="badge bg-primary">–û–∂–∏–¥–∞–µ—Ç</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ import_item.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ import_item.records_count }}</td>
                                    <td>
                                        <a href="{% url 'subscribers:import_detail' import_item.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> –î–µ—Ç–∞–ª–∏
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {% if history_page.has_other_pages %}
                <div class="card-footer">
                    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏–º–ø–æ—Ä—Ç–∞">
                        <ul class="pagination justify-content-center mb-0">
                            {% if history_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1" aria-label="–í –Ω–∞—á–∞–ª–æ">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ history_page.previous_page_number }}" aria-label="–ù–∞–∑–∞–¥">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="–í –Ω–∞—á–∞–ª–æ">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="–ù–∞–∑–∞–¥">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in history_page.paginator.page_range %}
                                {% if num == 1 or num == history_page.paginator.num_pages or num >= history_page.number|add:'-2' and num <= history_page.number|add:'2' %}
                                    {% if history_page.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% elif num == history_page.number|add:'-3' or num == history_page.number|add:'3' %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if history_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ history_page.next_page_number }}" aria-label="–í–ø–µ—Ä–µ–¥">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ history_page.paginator.num_pages }}" aria-label="–í –∫–æ–Ω–µ—Ü">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="–í–ø–µ—Ä–µ–¥">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="–í –∫–æ–Ω–µ—Ü">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <h4 class="alert-heading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–º–ø–æ—Ä—Ç–µ</h4>
            <p class="mb-0">–ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–∞ –ø—É—Å—Ç–∞. –ù–∞—á–Ω–∏—Ç–µ —Å <a href="{% url 'subscribers:import_csv' %}" class="alert-link">–∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</a>.</p>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cleanupBtn = document.getElementById('cleanup-archives-btn');
    const listArchivesBtn = document.getElementById('list-archives-btn');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏–≤—ã"
    if (listArchivesBtn) {
        listArchivesBtn.addEventListener('click', function() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            listArchivesBtn.disabled = true;
            listArchivesBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤
            fetch('{% url "subscribers:list_archives" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = `–ù–∞–π–¥–µ–Ω–æ –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: ${data.total_count}\n\n`;
                    
                    if (data.tables && data.tables.length > 0) {
                        data.tables.forEach(table => {
                            message += `üìã ${table.name}\n`;
                            message += `   –ö–æ–ª–æ–Ω–æ–∫: ${table.columns}, –°—Ç—Ä–æ–∫: ${table.rows}\n\n`;
                        });
                    } else {
                        message += '–ê—Ä—Ö–∏–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
                    }
                    
                    alert(message);
                } else {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤');
            })
            .finally(() => {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                listArchivesBtn.disabled = false;
                listArchivesBtn.innerHTML = '<i class="bi bi-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏–≤—ã';
            });
        });
    }
    
    if (cleanupBtn) {
        cleanupBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã? –ë—É–¥—É—Ç –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ 3 –ø–æ—Å–ª–µ–¥–Ω–∏–µ.')) {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                cleanupBtn.disabled = true;
                cleanupBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –û—á–∏—Å—Ç–∫–∞...';
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
                fetch('{% url "subscribers:cleanup_archives" %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        window.location.reload();
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data.success) {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        let message = `–ê—Ä—Ö–∏–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã!\n\n${data.message}\n\n`;
                        
                        if (data.before_cleanup && data.after_cleanup) {
                            message += `–î–æ –æ—á–∏—Å—Ç–∫–∏: ${data.before_cleanup.total_count} —Ç–∞–±–ª–∏—Ü\n`;
                            message += `–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: ${data.after_cleanup.total_count} —Ç–∞–±–ª–∏—Ü\n`;
                            message += `–£–¥–∞–ª–µ–Ω–æ: ${data.total_deleted} —Ç–∞–±–ª–∏—Ü`;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
                        alert(message);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                        window.location.reload();
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        let errorMessage = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ${data.error}`;
                        
                        if (data.before_cleanup) {
                            errorMessage += `\n\n–ù–∞–π–¥–µ–Ω–æ –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: ${data.before_cleanup.total_count}`;
                        }
                        
                        alert(errorMessage);
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        cleanupBtn.disabled = false;
                        cleanupBtn.innerHTML = '<i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∞—Ä—Ö–∏–≤–æ–≤:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü');
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    cleanupBtn.disabled = false;
                    cleanupBtn.innerHTML = '<i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã';
                });
            }
        });
    }
});
</script>

{% endblock %} 